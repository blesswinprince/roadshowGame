<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Test Early. Ship Stable.</title>

<style>
  :root{
    --bg-blue:#0284c7;
    --bg-green:#16a34a;
    --text:#f9fafb;
    --muted:#9ca3af;
    --ok:#22c55e;
    --fail:#f97316;
    --active:#38bdf8;
  }
  *{box-sizing:border-box;}

  html,body{
    margin:0;
    height:100%;
  }

  body{
    margin:0;
    height:100%;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 0% 0%,var(--bg-blue) 0,#020617 45%),
      radial-gradient(circle at 100% 100%,var(--bg-green) 0,#020617 45%),
      #020617;
    overflow:hidden;
  }

  .shell{
    width:100%;
    height:100%;
    padding:12px 16px;
  }

  .card{
    position:relative;
    width:100%;
    height:100%;
    border-radius:0;
    background:
      radial-gradient(circle at top left,rgba(148,163,184,.16),transparent 55%),
      rgba(15,23,42,.97);
    border:1px solid rgba(148,163,184,.6);
    box-shadow:0 26px 70px rgba(15,23,42,.95);
    padding:16px 20px 18px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:10px;
  }

  .header-main{
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .hero-title{
    font-size:30px;
    font-weight:750;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .hero-subtitle{
    font-size:16px;
    font-weight:600;
    color:#e5e7eb;
  }

  .hero-caption{
    font-size:13px;
    color:var(--muted);
  }

  .play-btn{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.98);
    padding:6px 14px;
    font-size:12px;
    color:#e5e7eb;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
    box-shadow:0 0 12px rgba(15,23,42,.8);
  }
  .play-btn span.icon{
    font-size:14px;
  }

  .layout{
    display:flex;
    flex-direction:row;
    gap:16px;
    flex:1;
    min-height:0;
  }

  .layout-left{
    flex:0 0 280px;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .layout-right{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }

  .dev-panel{
    border-radius:20px;
    border:1px solid rgba(148,163,184,.55);
    background:
      radial-gradient(circle at top left,rgba(56,189,248,.18),transparent 65%),
      radial-gradient(circle at bottom right,rgba(52,211,153,.16),transparent 65%),
      #020617;
    padding:10px 14px 9px;
    display:flex;
    flex-direction:column;
    gap:12px;
    height:100%;
  }

  .dev-left{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .dev-avatar{
    width:60px;
    height:60px;
    border-radius:20px;
    background:radial-gradient(circle at 30% 20%,#facc15,#fb7185);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    box-shadow:0 0 20px rgba(248,250,252,.7);
  }

  .dev-meta{display:flex;flex-direction:column;gap:3px;}
  .dev-name{font-size:14px;font-weight:600;}
  .dev-branch{font-size:12px;color:#a5b4fc;}
  .dev-repo{
    margin-top:2px;
    font-size:11px;
    color:var(--muted);
    border-radius:999px;
    padding:3px 8px;
    border:1px solid rgba(148,163,184,.7);
    width:fit-content;
  }

  .pr-card{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.6);
    background:
      radial-gradient(circle at top left,rgba(56,189,248,.18),transparent 60%),
      rgba(15,23,42,.98);
    padding:7px 11px;
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .pr-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .pr-title{font-size:13px;font-weight:600;}
  .pr-sub{font-size:11px;color:var(--muted);min-height:14px;}
  .pr-pill{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.95);
    white-space:nowrap;
  }

  .pr-pill.merged{
    border-color:rgba(34,197,94,.9);
    color:#bbf7d0;
    box-shadow:0 0 10px rgba(34,197,94,.7);
  }

  .pr-branches{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
  .pr-branches span.branch{
    padding:2px 7px;
    border-radius:999px;
    border:1px solid rgba(55,65,81,.9);
    background:rgba(15,23,42,.95);
  }
  .pr-branches span.arrow{opacity:.7;}

  .pipelines-area{
    display:flex;
    flex-direction:column;
    gap:10px;
    flex:1;
    min-height:0;
  }

  .pipe-panel{
    border-radius:20px;
    border:1px solid rgba(148,163,184,.55);
    background:radial-gradient(circle at top,rgba(15,23,42,1),#020617);
    padding:10px 14px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .pipe-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .pipe-title{font-size:16px;font-weight:650;}
  .pipe-mode{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.95);
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .pipe-mode.tobe{
    border-color:rgba(52,211,153,.9);
    color:#bbf7d0;
  }

  .pipe-status{font-size:12px;color:var(--muted);min-height:16px;}

  .pipe-list{
    list-style:none;
    padding:0;
    margin:4px 0 2px;
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:nowrap;
    align-items:center;
  }

  .pipe-step{
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    padding:10px 12px;
    border-radius:14px;
    min-width:110px;
    max-width:150px;
    background:rgba(15,23,42,.95);
    border:1px solid rgba(55,65,81,.9);
    font-size:13px;
  }

  /* PR / MERGE big container cards */
  .pipe-step-pr{
    min-width:260px;
    max-width:360px;
    align-items:flex-start;
  }

  .pipe-main{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    text-align:left;
  }

  .pipe-sub{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }

  .pipe-label{
    font-size:13px;
  }

  .pipe-step--active{
    box-shadow:0 0 14px rgba(56,189,248,.7);
    border-color:var(--active);
  }

  .pipe-step--ok{
    border-color:var(--ok);
    background:#022c22;
    box-shadow:0 0 10px rgba(34,197,94,.7);
  }

  .pipe-step--fail{
    border-color:var(--fail);
    background:#451a03;
    box-shadow:0 0 10px rgba(249,115,22,.8);
  }

  /* Big outer frame inside PR / Merge */
  .pipe-pr-frame{
    width:100%;
    margin-top:8px;
    padding:8px 10px;
    border-radius:14px;
    border:0px solid rgba(148,163,184,0.4);
    background:rgba(15,23,42,0.9);
  }

  /* Inner test pills inside that frame */
  .pipe-pr-tests{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }

  .pipe-pr-test{
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    font-size:11px;
    color:var(--muted);
    background:rgba(15,23,42,0.95);
    white-space:nowrap;
  }

  /* Inner test animation states */
  .pipe-pr-test--active{
    border-color: var(--active);
    box-shadow: 0 0 8px rgba(56,189,248,0.8);
    color: #e5e7eb;
  }

  .pipe-pr-test--ok{
    border-color: var(--ok);
    background:#022c22;
    color:#bbf7d0;
    box-shadow:0 0 6px rgba(34,197,94,0.7);
  }

  .pipe-pr-test--fail{
    border-color: var(--fail);
    background:#451a03;
    color:#fed7aa;
    box-shadow:0 0 6px rgba(249,115,22,0.8);
  }

  /* PR approved + Deploy pills (flat icon cards) */
  .pipe-step-arrow,
  .pipe-step-deploy{
    min-width:auto;
    max-width:none;
    padding:0;
    border:none;
    background:transparent;
    box-shadow:none;
  }

  .pipe-arrow-pill,
  .pipe-deploy-pill{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:0px solid rgba(148,163,184,0.5);
    //background:rgba(15,23,42,0.96);
    font-size:11px;
    color:var(--muted);
    transition:box-shadow .2s ease, border-color .2s ease, background .2s ease;
  }

  /* Flat circular icon */
  .pill-icon-circle{
    width:22px;
    height:22px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:rgba(148,163,184,0.9);
    background:transparent;
    transition:background .2s ease,color .2s ease,border-color .2s ease;
  }

  /* Text block next to icon */
  .pill-text{
    display:flex;
    flex-direction:column;
    gap:1px;
  }

  .pill-text-title{
    font-size:11px;
    font-weight:600;
    color:#e5e7eb;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .pill-text-sub{
    font-size:10px;
    color:var(--muted);
  }

  /* When that step is executed */
  .pipe-arrow-pill.pill-done{
    border-color:var(--ok);
    box-shadow:0 0 10px rgba(34,197,94,0.7);
  }
  .pipe-arrow-pill.pill-done .pill-icon-circle{
    background:var(--ok);
    border-color:var(--ok);
    color:#022c22;
  }

  .pipe-deploy-pill.pill-done{
    border-color:var(--active);
    box-shadow:0 0 10px rgba(56,189,248,0.8);
  }
  .pipe-deploy-pill.pill-done .pill-icon-circle{
    background:var(--active);
    border-color:var(--active);
    color:#0b1120;
  }

  /* TEST env as a small pill in the row, after Deploy */
  .pipe-step-env{
    min-width:auto;
    max-width:none;
    padding:0;
    border:none;
    background:transparent;
    box-shadow:none;
  }

  .env-box{
    border-radius:14px;
    padding:6px 9px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    border:1px solid rgba(148,163,184,.7);
    background:rgba(15,23,42,.96);
    font-size:11px;
    min-width:160px;
    transition:box-shadow .2s ease,border-color .2s ease;
  }
  .env-pill{
    border-radius:999px;
    padding:3px 9px;
    border:0px solid rgba(148,163,184,.8);
    display:inline-flex;
    gap:6px;
    align-items:center;
  }

  .env-dot{
    width:9px;height:9px;border-radius:999px;background:#6b7280;
  }

  .env-status{
    color:var(--muted);
  }

  .env-box.ok{
    border-color:rgba(34,197,94,.9);
    box-shadow:0 0 12px rgba(34,197,94,.7);
  }
  .env-box.ok .env-dot{background:var(--ok);}

  .env-box.fail{
    border-color:rgba(248,113,113,.9);
    box-shadow:0 0 12px rgba(248,113,113,.7);
  }
  .env-box.fail .env-dot{background:var(--fail);}

  .insights-panel{
    display:flex;
    gap:16px;
    margin-top:4px;
    font-size:12px;
  }

  /* reserve height so the card doesn‚Äôt jump when bullets appear */
  .insights-col{
    flex:1;
    border-radius:12px;
    padding:6px 8px;
    border:1px solid rgba(148,163,184,.3);
    background:rgba(15,23,42,.9);

    display:flex;
    flex-direction:column;
    min-height:90px; /* tweak as you like */
  }

  .insights-title{
    font-size:11px;
    font-weight:600;
    margin-bottom:4px;
  }

  /* list fills remaining space but doesn‚Äôt change outer height */
  .insights-list{
    list-style:none;
    padding-left:0;
    margin:0;
    flex:1;
  }

  .insight-item{
    opacity:0;
    transform:translateY(4px);
    transition:.2s ease-out;
    margin-bottom:3px;
    color:var(--muted);
  }
  .insight-item.visible{
    opacity:1;transform:translateY(0);
  }

  @media(max-width:900px){
    .card{border-radius:0;}
    .layout{flex-direction:column;}
    .pipe-list{flex-wrap:wrap;justify-content:flex-start;}
  }
</style>
</head>

<body>
<div class="shell">
  <div class="card">
    <div class="card-header">
      <div class="header-main">
        <div class="hero-title">Test Early. Ship Stable.</div>
        <div class="hero-subtitle">AS-IS vs TO-BE CI/CD pipelines, using the exact same PR.</div>
        <div class="hero-caption">
          PR checks ‚Üí manual approval ‚Üí merge checks ‚Üí deploy marker ‚Üí TEST status.
        </div>
      </div>
      <button id="playToggle" class="play-btn">
        <span class="icon">‚è∏</span>
        <span class="label">Pause</span>
      </button>
    </div>

    <div class="layout">
      <div class="layout-left">
        <div class="dev-panel">
          <div class="dev-left">
            <div class="dev-avatar">üë©‚Äçüíª</div>
            <div class="dev-meta">
              <div class="dev-name">Developer: Dev</div>
              <div class="dev-branch">branch: <strong>feature/booking-contract</strong></div>
              <div class="dev-repo">repo: amadeus / booking-api</div>
            </div>
          </div>

          <div class="pr-card">
            <div class="pr-top">
              <div>
                <div class="pr-title">PR #1289 ‚Äì Align booking API contracts</div>
                <div id="prSub" class="pr-sub">Created just now ¬∑ comparison running</div>
              </div>
              <div id="prPill" class="pr-pill">Open ¬∑ under comparison</div>
            </div>
            <div class="pr-branches">
              <span class="branch">feature/booking-contract</span>
              <span class="arrow">‚á¢</span>
              <span class="branch">master</span>
            </div>
          </div>
        </div>
      </div>

      <div class="layout-right">
        <div class="pipelines-area">

          <!-- AS-IS -->
          <div class="pipe-panel">
            <div class="pipe-header">
              <div class="pipe-title">AS-IS pipeline</div>
              <div class="pipe-mode">AS-IS (today)</div>
            </div>
            <div id="pipeStatusAsIs" class="pipe-status"></div>
            <ul id="pipeListAsIs" class="pipe-list"></ul>
            <div class="insights-panel">
              <div class="insights-col">
                <div class="insights-title">Pros</div>
                <ul id="prosAsIs" class="insights-list"></ul>
              </div>
              <div class="insights-col">
                <div class="insights-title">Cons</div>
                <ul id="consAsIs" class="insights-list"></ul>
              </div>
            </div>
          </div>

          <!-- TO-BE -->
          <div class="pipe-panel">
            <div class="pipe-header">
              <div class="pipe-title">TO-BE pipeline</div>
              <div class="pipe-mode tobe">TO-BE (shift-left)</div>
            </div>
            <div id="pipeStatusToBe" class="pipe-status"></div>
            <ul id="pipeListToBe" class="pipe-list"></ul>
            <div class="insights-panel">
              <div class="insights-col">
                <div class="insights-title">Pros</div>
                <ul id="prosToBe" class="insights-list"></ul>
              </div>
              <div class="insights-col">
                <div class="insights-title">Cons</div>
                <ul id="consToBe" class="insights-list"></ul>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const prPill = document.getElementById("prPill");
  const prSub  = document.getElementById("prSub");
  const playBtn = document.getElementById("playToggle");
  const playIcon = playBtn.querySelector(".icon");
  const playLabel = playBtn.querySelector(".label");

  let storyToken = 0;
  let isPaused = false;

  function updatePlayButton(){
    if(isPaused){
      playIcon.textContent = "‚ñ∂";
      playLabel.textContent = "Play";
    }else{
      playIcon.textContent = "‚è∏";
      playLabel.textContent = "Pause";
    }
  }

  playBtn.addEventListener("click", ()=>{
    isPaused = !isPaused;
    updatePlayButton();
  });

  // pause-aware delay
  function delay(ms){
    return new Promise(resolve=>{
      let remaining = ms;
      function step(){
        if(!isPaused){
          if(remaining <= 0){
            resolve();
            return;
          }
          const slice = Math.min(120, remaining);
          remaining -= slice;
        }
        setTimeout(step, 100);
      }
      step();
    });
  }

  const pipelines={
    "as-is":{
      pipeList:document.getElementById("pipeListAsIs"),
      pipeStatus:document.getElementById("pipeStatusAsIs"),
      prosList:document.getElementById("prosAsIs"),
      consList:document.getElementById("consAsIs"),
      envBox:null,
      envStatus:null
    },
    "to-be":{
      pipeList:document.getElementById("pipeListToBe"),
      pipeStatus:document.getElementById("pipeStatusToBe"),
      prosList:document.getElementById("prosToBe"),
      consList:document.getElementById("consToBe"),
      envBox:null,
      envStatus:null
    }
  };

  /* ------------ ENV helpers ------------ */

  function setEnvLabel(mode,text){
    const ctx=pipelines[mode];
    if(!ctx.envBox || !ctx.envStatus) return;
    ctx.envBox.classList.remove("ok","fail");
    ctx.envStatus.textContent=text;
  }
  function resetEnv(mode){
    setEnvLabel(mode,"Idle ‚Äì waiting for build‚Ä¶");
  }
  function setEnvState(mode,state,text){
    const ctx=pipelines[mode];
    if(!ctx.envBox || !ctx.envStatus) return;
    ctx.envBox.classList.remove("ok","fail");
    ctx.envBox.classList.add(state);
    ctx.envStatus.textContent=text;
  }

  /* ------------ Pros / Cons ------------ */

  function resetProsCons(mode){
    const ctx=pipelines[mode];
    ctx.prosList.innerHTML="";
    ctx.consList.innerHTML="";
  }

  function addPro(mode,text){
    const li=document.createElement("li");
    li.textContent=text;
    li.className="insight-item";
    pipelines[mode].prosList.appendChild(li);
    requestAnimationFrame(()=>li.classList.add("visible"));
  }

  function addCon(mode,text){
    const li=document.createElement("li");
    li.textContent=text;
    li.className="insight-item";
    pipelines[mode].consList.appendChild(li);
    requestAnimationFrame(()=>li.classList.add("visible"));
  }

  /* ------------ Build steps (PR, arrow, Merge, Deploy pill, Env) ------------ */

  function buildSteps(mode){
    const ctx=pipelines[mode];
    ctx.pipeList.innerHTML="";
    ctx.envBox=null;
    ctx.envStatus=null;

    let steps;
    if(mode==="as-is"){
      steps=[
        {
          type:"pr",
          label:"PR CREATED",
          caption:"Checks inside the PR",
          tests:["Unit tests","Functional tests"]
        },
        {
          type:"arrow",
          label:"PR approved"
        },
        {
          type:"merge",
          label:"MERGE TO MASTER",
          caption:"Checks on merged branch",
          tests:["Unit tests","Functional tests"]
        },
        {
          type:"deployMarker",
          label:"Deploy to TEST"
        }
      ];
    }else{
      steps=[
        {
          type:"pr",
          label:"PR CREATED",
          caption:"Checks inside the PR (CI)",
          tests:["Unit tests","Functional tests","Contract tests","Integration tests"]
        },
        {
          type:"arrow",
          label:"PR approved"
        },
        {
          type:"merge",
          label:"MERGE TO MASTER",
          caption:"Checks on merged branch",
          tests:["Unit tests","Functional tests","Contract tests","Integration tests"]
        },
        {
          type:"deployMarker",
          label:"Deploy to TEST"
        }
      ];
    }

    steps.forEach(step=>{
      if(step.type==="arrow"){
        const li=document.createElement("li");
        li.className="pipe-step pipe-step-arrow";
        li.dataset.label = "PR approved";

        const pill=document.createElement("div");
        pill.className="pipe-arrow-pill";

        const iconCircle=document.createElement("span");
        iconCircle.className="pill-icon-circle";
        iconCircle.textContent="‚úì";

        const textWrap=document.createElement("div");
        textWrap.className="pill-text";

        const title=document.createElement("div");
        title.className="pill-text-title";
        title.textContent="PR APPROVED";

        const sub=document.createElement("div");
        sub.className="pill-text-sub";
        sub.textContent="Manual reviewer step";

        textWrap.appendChild(title);
        textWrap.appendChild(sub);

        pill.appendChild(iconCircle);
        pill.appendChild(textWrap);
        li.appendChild(pill);
        ctx.pipeList.appendChild(li);
        return;
      }

      if(step.type==="deployMarker"){
        const li=document.createElement("li");
        li.className="pipe-step pipe-step-deploy";
        li.dataset.label = "Deploy to TEST";

        const pill=document.createElement("div");
        pill.className="pipe-deploy-pill";

        const iconCircle=document.createElement("span");
        iconCircle.className="pill-icon-circle";
        iconCircle.textContent="‚¨Ü";

        const textWrap=document.createElement("div");
        textWrap.className="pill-text";

        const title=document.createElement("div");
        title.className="pill-text-title";
        title.textContent="DEPLOY TO TEST";

        const sub=document.createElement("div");
        sub.className="pill-text-sub";
        sub.textContent="Build sent to TEST env";

        textWrap.appendChild(title);
        textWrap.appendChild(sub);

        pill.appendChild(iconCircle);
        pill.appendChild(textWrap);
        li.appendChild(pill);
        ctx.pipeList.appendChild(li);
        return;
      }

      const li=document.createElement("li");
      li.className="pipe-step";
      if(step.type==="pr" || step.type==="merge"){
        li.classList.add("pipe-step-pr");
      }
      li.dataset.label = step.label;

      const main=document.createElement("div");
      main.className="pipe-main";

      const lbl=document.createElement("div");
      lbl.className="pipe-label";
      lbl.textContent=step.label;
      main.appendChild(lbl);

      if(step.caption){
        const sub=document.createElement("div");
        sub.className="pipe-sub";
        sub.textContent=step.caption;
        main.appendChild(sub);
      }

      if(step.tests && step.tests.length){
        const frame=document.createElement("div");
        frame.className="pipe-pr-frame";

        const wrap=document.createElement("div");
        wrap.className="pipe-pr-tests";

        step.tests.forEach(t=>{
          const pill=document.createElement("div");
          pill.className="pipe-pr-test";
          pill.textContent=t;
          wrap.appendChild(pill);
        });

        frame.appendChild(wrap);
        main.appendChild(frame);
      }

      li.appendChild(main);
      ctx.pipeList.appendChild(li);
    });

    // Add TEST env status as last item in row
    const envLi=document.createElement("li");
    envLi.className="pipe-step pipe-step-env";

    const envBox=document.createElement("div");
    envBox.className="env-box";

    const envPill=document.createElement("div");
    envPill.className="env-pill";

    const envDot=document.createElement("span");
    envDot.className="env-dot";

    const envLabel=document.createElement("span");
    envLabel.textContent="TEST env";

    envPill.appendChild(envDot);
    envPill.appendChild(envLabel);

    const envStatus=document.createElement("div");
    envStatus.className="env-status";
    envStatus.textContent="Idle ‚Äì waiting for build‚Ä¶";

    envBox.appendChild(envPill);
    envBox.appendChild(envStatus);
    envLi.appendChild(envBox);
    ctx.pipeList.appendChild(envLi);

    ctx.envBox=envBox;
    ctx.envStatus=envStatus;
  }

  /* ------------ Inner test animation ------------ */

  async function runInnerTests(stepElem, innerOutcomes, perTest, token){
    const tests = Array.from(stepElem.querySelectorAll(".pipe-pr-test"));
    let innerFailIdx = -1;

    for(let i=0;i<innerOutcomes.length && i<tests.length;i++){
      if(token!==storyToken) return {innerFailIdx};
      const pill = tests[i];
      const outcome = innerOutcomes[i]; // "ok" | "fail" | "skip"

      pill.classList.add("pipe-pr-test--active");
      await delay(perTest);
      if(token!==storyToken) return {innerFailIdx};
      pill.classList.remove("pipe-pr-test--active");

      if(outcome === "ok"){
        pill.classList.add("pipe-pr-test--ok");
      }else if(outcome === "fail"){
        pill.classList.add("pipe-pr-test--fail");
        innerFailIdx = i;
        break;
      }else{
        // skip ‚Äì leave neutral
      }
    }
    return {innerFailIdx};
  }

  /* ------------ Timeline animation for steps ------------ */
  /**
   * outcomes[i] can be:
   *  - "ok" | "fail" | "skipped" | "done"
   *  - { step: "ok" | "fail" | "skipped" | "done", inner: ["ok"|"fail"|"skip", ...] }
   *
   * Steps per pipeline: [PR, Arrow, Merge, DeployMarker]  (env pill is not animated)
   */
  async function runTimeline(mode,outcomes,{token,perStep}){
    const ctx=pipelines[mode];
    const steps=Array.from(ctx.pipeList.querySelectorAll(".pipe-step"))
                     .filter(li=>!li.classList.contains("pipe-step-env")); // ignore env box
    let failIdx=-1;

    for(let i=0;i<outcomes.length&&i<steps.length;i++){
      if(token!==storyToken) return{failIdx};

      const raw = outcomes[i];
      const isObj = typeof raw === "object";
      const stepOutcome = isObj ? (raw.step || "ok") : raw;
      const innerOutcomes = isObj ? (raw.inner || null) : null;

      const step=steps[i];
      const isArrow = step.classList.contains("pipe-step-arrow");
      const isDeploy = step.classList.contains("pipe-step-deploy");

      if(stepOutcome==="skipped"){
        continue;
      }

      const label = step.dataset.label || "Step";

      // Manual / marker steps (PR approved, Deploy)
      if(stepOutcome==="done" && (isArrow || isDeploy)){
        ctx.pipeStatus.textContent = label+" completed.";
        const pill = step.querySelector(isArrow?".pipe-arrow-pill":".pipe-deploy-pill");
        if(pill){
          pill.classList.add("pill-done");
        }
        await delay(Math.min(perStep, 800));
        continue;
      }

      // Normal PR / Merge steps
      step.classList.add("pipe-step--active");
      ctx.pipeStatus.textContent="Running "+label+"‚Ä¶";

      if(innerOutcomes && step.classList.contains("pipe-step-pr")){
        const perTest = Math.max(600, perStep / (innerOutcomes.length || 1));
        const {innerFailIdx} = await runInnerTests(step, innerOutcomes, perTest, token);
        if(token!==storyToken) return{failIdx};

        if(innerFailIdx>=0 && stepOutcome === "fail"){
          step.classList.remove("pipe-step--active");
          step.classList.add("pipe-step--fail");
          ctx.pipeStatus.textContent = label+" failed.";
          failIdx = i;
          break;
        }
      }else{
        await delay(perStep);
        if(token!==storyToken) return{failIdx};
      }

      step.classList.remove("pipe-step--active");

      if(stepOutcome==="ok"){
        step.classList.add("pipe-step--ok");
        ctx.pipeStatus.textContent=label+" passed.";
      } else if(stepOutcome==="fail"){
        step.classList.add("pipe-step--fail");
        ctx.pipeStatus.textContent=label+" failed.";
        failIdx=i;
        break;
      }
    }
    return{failIdx};
  }

  function resetPR(){
    prPill.className="pr-pill";
    prPill.textContent="Open ¬∑ under comparison";
    prSub.textContent="Created just now ¬∑ comparison running";
  }

  function resetPipeline(mode,{keepInsights=false}={}){
    const ctx=pipelines[mode];
    ctx.pipeList.innerHTML="";
    ctx.pipeStatus.textContent="";
    resetEnv(mode);
    if(!keepInsights){
      resetProsCons(mode);
    }
  }

  /* ------------ AS-IS: multiple TEST deployments ------------ */

  async function runAsIs(token){
    const mode="as-is";

    // Initial setup and static (summarised) pros/cons
    resetPipeline(mode,{keepInsights:false});
    buildSteps(mode);
    addPro(mode,"Simpler pipeline with fewer CI checks.");
    addPro(mode,"Faster PR validation in CI.");
    addCon(mode,"Issues are often detected only after deploy to TEST.");
    addCon(mode,"Shared TEST environment is more exposed to broken builds.");

    // Build #1 ‚Äì TEST fails
    setEnvLabel(mode,"Waiting for Build #1 with Dev‚Äôs PR‚Ä¶");

    let outcomes=[
      { step:"ok", inner:["ok","ok"] }, // PR checks
      "done",                           // PR approved (manual)
      { step:"ok", inner:["ok","ok"] }, // Merge checks (always ok)
      "done"                            // Deploy marker
    ];
    await runTimeline(mode,outcomes,{token,perStep:1800});
    if(token!==storyToken)return;
    setEnvState(mode,"fail","TEST failed ‚Äì issue detected after deploy.");
    await delay(1800);
    if(token!==storyToken)return;

    // Build #2 ‚Äì TEST fails again
    resetPipeline(mode,{keepInsights:true});
    buildSteps(mode);
    setEnvLabel(mode,"Waiting for Build #2 after initial fixes‚Ä¶");

    outcomes=[
      { step:"ok", inner:["ok","ok"] },
      "done",
      { step:"ok", inner:["ok","ok"] },
      "done"
    ];
    await runTimeline(mode,outcomes,{token,perStep:1800});
    if(token!==storyToken)return;
    setEnvState(mode,"fail","TEST failed again ‚Äì further issues after redeploy.");
    addCon(mode,"Repeated broken builds disrupt other teams using TEST.");
    await delay(1800);
    if(token!==storyToken)return;

    // Build #3 ‚Äì finally green
    resetPipeline(mode,{keepInsights:true});
    buildSteps(mode);
    setEnvLabel(mode,"Waiting for Build #3 after further fixes‚Ä¶");

    outcomes=[
      { step:"ok", inner:["ok","ok"] },
      "done",
      { step:"ok", inner:["ok","ok"] },
      "done"
    ];
    await runTimeline(mode,outcomes,{token,perStep:1800});
    if(token!==storyToken)return;
    setEnvState(mode,"ok","TEST passed ‚Äì environment is stable again.");
    addCon(mode,"Multiple builds are often required to stabilise the TEST environment.");
    await delay(2000);
  }

  /* ------------ TO-BE: CI catches issues, 1 TEST deploy ------------ */

  async function runToBe(token){
    const mode="to-be";

    resetPipeline(mode,{keepInsights:false});
    buildSteps(mode);

    // Summarised pros/cons for TO-BE
    addPro(mode,"CI runs contract and integration checks on the PR.");
    addPro(mode,"Only validated builds reach TEST.");
    addPro(mode,"Developers get faster feedback directly in CI.");
    addPro(mode,"Shared TEST environment stays more stable.");
    addCon(mode,"CI runs can be slightly longer per PR.");
    addCon(mode,"More test suites to maintain in CI.");

    // CI Run #1 ‚Äì fails in PR checks, no deploy
    setEnvLabel(mode,"CI Run #1 on Dev‚Äôs PR‚Ä¶");
    let outcomes=[
      {
        step:"fail",
        inner:["ok","ok","fail","skip"]
      },
      "skipped",
      { step:"ok", inner:["ok","ok","ok","ok"] },
      "skipped"
    ];
    await runTimeline(mode,outcomes,{token,perStep:1500});
    if(token!==storyToken)return;
    setEnvState(mode,"ok","TEST stays green ‚Äì PR is blocked in CI.");
    addPro(mode,"Early failures are contained on the PR branch instead of in TEST.");
    await delay(1600);
    if(token!==storyToken)return;

    // CI Run #2 ‚Äì another failure in PR checks, still no deploy
    resetPipeline(mode,{keepInsights:true});
    buildSteps(mode);
    setEnvLabel(mode,"CI Run #2 after early fixes‚Ä¶");
    outcomes=[
      {
        step:"fail",
        inner:["ok","ok","ok","fail"]
      },
      "skipped",
      { step:"ok", inner:["ok","ok","ok","ok"] },
      "skipped"
    ];
    await runTimeline(mode,outcomes,{token,perStep:1500});
    if(token!==storyToken)return;
    setEnvState(mode,"ok","TEST stays clean ‚Äì failures are stopped in CI.");
    addPro(mode,"TEST remains available for other teams even while this PR is failing.");
    await delay(1600);
    if(token!==storyToken)return;

    // CI Run #3 ‚Äì all green, one deploy to TEST
    resetPipeline(mode,{keepInsights:true});
    buildSteps(mode);
    setEnvLabel(mode,"CI Run #3 ‚Äì all checks expected to pass‚Ä¶");

    outcomes=[
      {
        step:"ok",
        inner:["ok","ok","ok","ok"]
      },
      "done",
      {
        step:"ok",
        inner:["ok","ok","ok","ok"]
      },
      "done"
    ];
    await runTimeline(mode,outcomes,{token,perStep:1500});
    if(token!==storyToken)return;
    setEnvState(mode,"ok","Single build reaches TEST ‚Äì green on first attempt.");
    addPro(mode,"Single clean TEST deployment for this PR.");
    await delay(2000);
  }

  /* ------------ Controller ------------ */

  async function playComparison(withIntro){
    const token=++storyToken;
    resetPR();
    resetPipeline("as-is",{keepInsights:false});
    buildSteps("as-is");
    resetPipeline("to-be",{keepInsights:false});
    buildSteps("to-be");

    if(withIntro) await delay(600);

    await runAsIs(token);
    if(token!==storyToken)return;
    await delay(1200);

    await runToBe(token);
    if(token!==storyToken)return;

    prPill.className="pr-pill merged";
    prPill.textContent="Merged ¬∑ TO-BE gives a cleaner path to TEST";
    prSub.textContent="Same PR ‚Äì AS-IS needs multiple TEST deploys vs TO-BE‚Äôs single deploy.";

    await delay(2400);
    playComparison(false);
  }

  updatePlayButton();
  playComparison(true);
})();
</script>

</body>
</html>
