<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Test Early. Ship Stable.</title>
<style>
  :root{
    --bg-blue:#0284c7;
    --bg-green:#16a34a;
    --text:#f9fafb;
    --muted:#9ca3af;
    --ok:#22c55e;
    --fail:#f97316;
    --active:#38bdf8;
  }
  *{box-sizing:border-box;}

  html,body{
    margin:0;
    height:100%;
  }

  body{
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 0% 0%,var(--bg-blue) 0,#020617 45%),
      radial-gradient(circle at 100% 100%,var(--bg-green) 0,#020617 45%),
      #020617;
    overflow:hidden; /* no scroll for roadshow screen */
  }

  .shell{
    width:100%;
    max-width:1400px;
    height:100%;
    padding:18px 26px;
  }

  .card{
    position:relative;
    border-radius:28px;
    background:
      radial-gradient(circle at top left,rgba(148,163,184,.16),transparent 55%),
      rgba(15,23,42,.97);
    border:1px solid rgba(148,163,184,.6);
    box-shadow:0 26px 70px rgba(15,23,42,.95);
    padding:18px 24px 20px;
    height:100%;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  /* hide old story / banner / speech if any */
  .step-banner,
  .story-strip,
  .dev-speech{
    display:none!important;
  }

  .card-header{
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-bottom:10px;
  }

  .hero-title{
    font-size:30px;
    font-weight:750;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .hero-subtitle{
    font-size:16px;
    font-weight:600;
    color:#e5e7eb;
  }

  .hero-caption{
    font-size:13px;
    color:var(--muted);
  }

  /* MAIN LAYOUT: Dev on the left, pipelines + TEST on the right */
  .layout{
    display:flex;
    flex-direction:row;
    gap:16px;
    flex:1;
    min-height:0;
  }

  .layout-left{
    flex:0 0 280px;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .layout-right{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:10px;
    min-height:0;
  }

  /* Dev panel */
  .dev-panel{
    border-radius:20px;
    border:1px solid rgba(148,163,184,.55);
    background:
      radial-gradient(circle at top left,rgba(56,189,248,.18),transparent 65%),
      radial-gradient(circle at bottom right,rgba(52,211,153,.16),transparent 65%),
      #020617;
    padding:10px 14px 9px;
    display:flex;
    flex-direction:column;
    gap:12px;
    height:100%;
  }

  .dev-left{
    display:flex;
    align-items:center;
    gap:12px;
  }

  .dev-avatar{
    width:60px;
    height:60px;
    border-radius:20px;
    background:radial-gradient(circle at 30% 20%,#facc15,#fb7185);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    box-shadow:0 0 20px rgba(248,250,252,.7);
  }
  .dev-meta{
    display:flex;
    flex-direction:column;
    gap:3px;
  }
  .dev-name{font-size:14px;font-weight:600;}
  .dev-branch{font-size:12px;color:#a5b4fc;}
  .dev-repo{
    margin-top:2px;
    font-size:11px;
    color:var(--muted);
    border-radius:999px;
    padding:3px 8px;
    border:1px solid rgba(148,163,184,.7);
    width:fit-content;
  }

  .pr-card{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.6);
    background:
      radial-gradient(circle at top left,rgba(56,189,248,.18),transparent 60%),
      rgba(15,23,42,.98);
    padding:7px 11px;
    display:flex;
    flex-direction:column;
    gap:4px;
    min-width:0;
  }
  .pr-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .pr-title{font-size:13px;font-weight:600;}
  .pr-sub{font-size:11px;color:var(--muted);min-height:14px;}
  .pr-pill{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.95);
    white-space:nowrap;
  }
  .pr-pill.merged{
    border-color:rgba(34,197,94,.9);
    color:#bbf7d0;
    box-shadow:0 0 10px rgba(34,197,94,.7);
  }

  .pr-branches{
    font-size:11px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:4px;
    flex-wrap:wrap;
  }
  .pr-branches span.branch{
    padding:2px 7px;
    border-radius:999px;
    border:1px solid rgba(55,65,81,.9);
    background:rgba(15,23,42,.95);
  }
  .pr-branches span.arrow{opacity:.7;}

  /* Pipelines stacked vertically */
  .pipelines-area{
    display:flex;
    flex-direction:column;
    gap:10px;
    flex:1;
    min-height:0;
  }

  .pipe-panel{
    border-radius:20px;
    border:1px solid rgba(148,163,184,.55);
    background:radial-gradient(circle at top,rgba(15,23,42,1),#020617);
    padding:10px 14px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:0;
  }
  .pipe-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .pipe-title{font-size:16px;font-weight:650;}
  .pipe-mode{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.8);
    background:rgba(15,23,42,.95);
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .pipe-mode.tobe{
    border-color:rgba(52,211,153,.9);
    color:#bbf7d0;
  }

  .pipe-status{
    font-size:12px;
    color:var(--muted);
    min-height:16px;
  }

  /* HORIZONTAL PIPELINES */
  .pipe-list{
    list-style:none;
    padding:0;
    margin:4px 0 2px;
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
  }

  .pipe-step{
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:4px;
    padding:8px 10px;
    border-radius:14px;
    min-width:110px;
    max-width:150px;
    text-align:center;
    background:rgba(15,23,42,.95);
    border:1px solid rgba(55,65,81,.9);
    font-size:13px;
    color:var(--muted);
  }

  .pipe-icon{
    width:24px;
    height:24px;
    border-radius:999px;
    border:2px solid #4b5563;
    background:#020617;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#9ca3af;
  }

  .pipe-label{font-size:13px;}

  .pipe-step--active{
    box-shadow:0 0 14px rgba(56,189,248,.7);
    border-color:var(--active);
  }
  .pipe-step--active .pipe-icon{
    border-color:var(--active);
    color:var(--active);
    box-shadow:0 0 10px rgba(56,189,248,.9);
  }
  .pipe-step--active .pipe-label{color:#e5e7eb;}

  .pipe-step--ok{
    border-color:var(--ok);
    background:#022c22;
    box-shadow:0 0 10px rgba(34,197,94,.7);
  }
  .pipe-step--ok .pipe-icon{
    border-color:var(--ok);
    background:#022c22;
    color:#bbf7d0;
  }
  .pipe-step--ok .pipe-label{color:#bbf7d0;}

  .pipe-step--fail{
    border-color:var(--fail);
    background:#451a03;
    box-shadow:0 0 10px rgba(249,115,22,.8);
  }
  .pipe-step--fail .pipe-icon{
    border-color:var(--fail);
    background:#451a03;
    color:#fed7aa;
  }
  .pipe-step--fail .pipe-label{color:#fed7aa;}

  .pipe-step--skipped{
    opacity:.55;
  }
  .pipe-step--skipped .pipe-icon{
    border-style:dashed;
    border-color:#6b7280;
  }

  /* TEST ENV AS SEPARATE PANEL */
  .test-panel{
    border-radius:18px;
    border:1px solid rgba(148,163,184,.55);
    background:radial-gradient(circle at top,rgba(15,23,42,.98),#020617);
    padding:8px 12px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .test-header{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#e5e7eb;
    opacity:.9;
  }

  /* TEST env box (logic stays the same) */
  .env-box{
    border-radius:14px;
    padding:6px 9px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    border:1px solid rgba(148,163,184,.7);
    background:rgba(15,23,42,.96);
    font-size:11px;
  }
  .env-pill{
    border-radius:999px;
    padding:3px 9px;
    border:1px solid rgba(148,163,184,.8);
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:rgba(15,23,42,.98);
    font-size:11px;
  }
  .env-dot{
    width:9px;
    height:9px;
    border-radius:999px;
    background:#6b7280; /* grey by default */
  }
  .env-status{color:var(--muted);}

  .env-box.ok{
    border-color:rgba(34,197,94,.9);
    box-shadow:0 0 12px rgba(34,197,94,.7);
  }
  .env-box.ok .env-pill{border-color:rgba(34,197,94,.9);}
  .env-box.ok .env-dot{
    background:var(--ok);
    box-shadow:0 0 8px rgba(34,197,94,.9);
  }
  .env-box.ok .env-status{color:#bbf7d0;}

  .env-box.fail{
    border-color:rgba(248,113,113,.9);
    box-shadow:0 0 12px rgba(248,113,113,.7);
  }
  .env-box.fail .env-pill{border-color:rgba(248,113,113,.9);}
  .env-box.fail .env-dot{
    background:var(--fail);
    box-shadow:0 0 8px rgba(248,113,113,.9);
  }
  .env-box.fail .env-status{color:#fecaca;}

  /* Pros / Cons */
  .insights-panel{
    display:flex;
    gap:16px;
    margin-top:4px;
    font-size:12px;
  }
  .insights-col{
    flex:1;
    border-radius:12px;
    padding:6px 8px;
    border:1px dashed rgba(148,163,184,.5);
    background:rgba(15,23,42,.9);
  }
  .insights-title{
    font-size:11px;
    font-weight:600;
    color:#e5e7eb;
    margin-bottom:4px;
    text-transform:uppercase;
    letter-spacing:.06em;
  }
  .insights-list{
    list-style:none;
    margin:0;
    padding-left:0;
  }
  .insight-item{
    opacity:0;
    transform:translateY(4px);
    transition:all .2s ease-out;
    margin-bottom:3px;
    color:var(--muted);
  }
  .insight-item.visible{
    opacity:1;
    transform:translateY(0);
  }

  @media(max-width:900px){
    .card{border-radius:0;}
    .layout{
      flex-direction:column;
    }
    .layout-left{
      flex:0 0 auto;
    }
    .pipe-list{flex-wrap:wrap;}
  }
</style>
</head>
<body>
<div class="shell">
  <div class="card">
    <div class="card-header">
      <div class="hero-title">Test Early. Ship Stable.</div>
      <div class="hero-subtitle">AS-IS vs TO-BE CI/CD pipelines, using the exact same PR.</div>
      <div class="hero-caption">Watch how adding contract & integration checks in CI protects TEST and shortens the feedback loop.</div>
    </div>

    <div class="layout">
      <!-- LEFT: Developer + PR (source of all builds / fixes) -->
      <div class="layout-left">
        <div class="dev-panel">
          <div class="dev-left">
            <div class="dev-avatar">üë©‚Äçüíª</div>
            <div class="dev-meta">
              <div class="dev-name">Developer: Dev</div>
              <div class="dev-branch">branch: <strong>feature/booking-contract</strong></div>
              <div class="dev-repo">repo: amadeus / booking-api</div>
            </div>
          </div>

          <div class="pr-card">
            <div class="pr-top">
              <div>
                <div class="pr-title">PR #1289 ‚Äì Align booking API contracts</div>
                <div id="prSub" class="pr-sub">Created just now ¬∑ comparison running side by side</div>
              </div>
              <div id="prPill" class="pr-pill">Open ¬∑ under comparison</div>
            </div>
            <div class="pr-branches">
              <span class="branch">feature/booking-contract</span>
              <span class="arrow">‚á¢</span>
              <span class="branch">master</span>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Pipelines + TEST env impact -->
      <div class="layout-right">
        <div class="pipelines-area">
          <!-- AS-IS -->
          <div class="pipe-panel">
            <div class="pipe-header">
              <div class="pipe-title">AS-IS pipeline</div>
              <div class="pipe-mode">AS-IS (today)</div>
            </div>
            <div id="pipeStatusAsIs" class="pipe-status"></div>
            <ul id="pipeListAsIs" class="pipe-list"></ul>

            <div class="insights-panel">
              <div class="insights-col">
                <div class="insights-title">Pros</div>
                <ul id="prosAsIs" class="insights-list"></ul>
              </div>
              <div class="insights-col">
                <div class="insights-title">Cons</div>
                <ul id="consAsIs" class="insights-list"></ul>
              </div>
            </div>
          </div>

          <!-- AS-IS TEST env as its own component -->
          <div class="test-panel">
            <div class="test-header">AS-IS ‚Äì TEST environment impact</div>
            <div id="envBoxAsIs" class="env-box">
              <div class="env-pill">
                <span class="env-dot"></span>
                <span>TEST env</span>
              </div>
              <div id="envStatusAsIs" class="env-status">Idle ‚Äì waiting for build‚Ä¶</div>
            </div>
          </div>

          <!-- TO-BE -->
          <div class="pipe-panel">
            <div class="pipe-header">
              <div class="pipe-title">TO-BE pipeline</div>
              <div class="pipe-mode tobe">TO-BE (shift-left)</div>
            </div>
            <div id="pipeStatusToBe" class="pipe-status"></div>
            <ul id="pipeListToBe" class="pipe-list"></ul>

            <div class="insights-panel">
              <div class="insights-col">
                <div class="insights-title">Pros</div>
                <ul id="prosToBe" class="insights-list"></ul>
              </div>
              <div class="insights-col">
                <div class="insights-title">Cons</div>
                <ul id="consToBe" class="insights-list"></ul>
              </div>
            </div>
          </div>

          <!-- TO-BE TEST env as its own component -->
          <div class="test-panel">
            <div class="test-header">TO-BE ‚Äì TEST environment impact</div>
            <div id="envBoxToBe" class="env-box">
              <div class="env-pill">
                <span class="env-dot"></span>
                <span>TEST env</span>
              </div>
              <div id="envStatusToBe" class="env-status">Idle ‚Äì waiting for build‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- layout -->
  </div>
</div>
<script>
(function(){
  const prPill = document.getElementById("prPill");
  const prSub  = document.getElementById("prSub");
  const delay  = (ms) => new Promise(res=>setTimeout(res,ms));
  let storyToken = 0;

  const pipelines = {
    "as-is": {
      pipeList:   document.getElementById("pipeListAsIs"),
      pipeStatus: document.getElementById("pipeStatusAsIs"),
      envBox:     document.getElementById("envBoxAsIs"),
      envStatus:  document.getElementById("envStatusAsIs"),
      prosList:   document.getElementById("prosAsIs"),
      consList:   document.getElementById("consAsIs")
    },
    "to-be": {
      pipeList:   document.getElementById("pipeListToBe"),
      pipeStatus: document.getElementById("pipeStatusToBe"),
      envBox:     document.getElementById("envBoxToBe"),
      envStatus:  document.getElementById("envStatusToBe"),
      prosList:   document.getElementById("prosToBe"),
      consList:   document.getElementById("consToBe")
    }
  };

  /* ---------- ENV helpers ---------- */

  function resetEnv(mode){
    const ctx = pipelines[mode];
    ctx.envBox.classList.remove("ok","fail");
    ctx.envStatus.textContent = "Idle ‚Äì waiting for build‚Ä¶";
  }

  function setEnvLabel(mode,text){
    const ctx = pipelines[mode];
    ctx.envBox.classList.remove("ok","fail");
    ctx.envStatus.textContent = text;
  }

  function setEnvState(mode,state,text){
    const ctx = pipelines[mode];
    ctx.envBox.classList.remove("ok","fail");
    if(state === "ok")   ctx.envBox.classList.add("ok");
    if(state === "fail") ctx.envBox.classList.add("fail");
    ctx.envStatus.textContent = text;
  }

  /* ---------- Pros / Cons ---------- */

  function resetProsCons(mode){
    const ctx = pipelines[mode];
    ctx.prosList.innerHTML = "";
    ctx.consList.innerHTML = "";
  }

  function addPro(mode,text){
    const ctx = pipelines[mode];
    const li = document.createElement("li");
    li.textContent = text;
    li.className = "insight-item";
    ctx.prosList.appendChild(li);
    requestAnimationFrame(()=>li.classList.add("visible"));
  }

  function addCon(mode,text){
    const ctx = pipelines[mode];
    const li = document.createElement("li");
    li.textContent = text;
    li.className = "insight-item";
    ctx.consList.appendChild(li);
    requestAnimationFrame(()=>li.classList.add("visible"));
  }

  /* ---------- Steps ---------- */

  function buildSteps(mode){
    const ctx = pipelines[mode];
    ctx.pipeList.innerHTML = "";

    let labels;
    if(mode === "as-is"){
      labels = [
        "PR CREATED (Unit + functional tests)",
        "Merge to master",
        "Deploy to TEST"
      ];
    }else{
      labels = [
        "PR CREATED (Unit + functional + contract + integration checks in CI)",
        "Merge to master",
        "Deploy to TEST"
      ];
    }

    labels.forEach((label,idx)=>{
      const li = document.createElement("li");
      li.className = "pipe-step";
      const icon = document.createElement("div");
      icon.className = "pipe-icon";
      icon.textContent = idx+1;
      const lbl = document.createElement("div");
      lbl.className = "pipe-label";
      lbl.textContent = label;
      li.appendChild(icon);
      li.appendChild(lbl);
      ctx.pipeList.appendChild(li);
    });
  }

  function resetPipeline(mode){
    const ctx = pipelines[mode];
    ctx.pipeStatus.textContent = "";
    ctx.pipeList.innerHTML = "";
    resetEnv(mode);
    resetProsCons(mode);
  }

  async function runTimeline(mode,outcomes,{token,perStep}){
    const ctx = pipelines[mode];
    const steps = Array.from(ctx.pipeList.querySelectorAll(".pipe-step"));
    let failIdx = -1;
    const skipped = [];

    for(let i=0;i<outcomes.length && i<steps.length;i++){
      if(token !== storyToken) return {failIdx};
      const outcome = outcomes[i];
      const step = steps[i];
      const label = step.querySelector(".pipe-label").textContent;

      if(outcome === "skipped"){
        skipped.push(i);
        continue;
      }

      step.classList.add("pipe-step--active");
      ctx.pipeStatus.textContent = "Running " + label + "‚Ä¶";

      await delay(perStep);
      if(token !== storyToken) return {failIdx};

      step.classList.remove("pipe-step--active");

      if(outcome === "ok"){
        step.classList.add("pipe-step--ok");
        ctx.pipeStatus.textContent = label + " passed.";
      }else if(outcome === "fail"){
        step.classList.add("pipe-step--fail");
        ctx.pipeStatus.textContent = label + " failed.";
        failIdx = i;
        break;
      }
    }

    skipped.forEach(i=>{
      const step = steps[i];
      if(!step) return;
      step.classList.add("pipe-step--skipped");
    });

    return {failIdx};
  }

  /* ---------- PR pill ---------- */

  function resetPR(){
    prPill.className = "pr-pill";
    prPill.textContent = "Open ¬∑ under comparison";
    prSub.textContent  = "Created just now ¬∑ comparison running side by side";
  }

  /* ---------- AS-IS behaviour (3 TEST deployments) ---------- */

  async function runAsIs(token){
    const mode = "as-is";

    resetPipeline(mode);
    buildSteps(mode);

    addPro(mode,"Simple flow ‚Äì fewer CI stages today.");
    addCon(mode,"Quality gates are late ‚Äì issues only show up after deploy to TEST.");

    // Build 1 ‚Äì contract issue only seen in TEST
    setEnvLabel(mode,"Waiting for Build #1 with Dev‚Äôs PR‚Ä¶");
    addCon(mode,"Build #1 reaches TEST with a hidden contract bug.");

    let outcomes = ["ok","ok","fail"]; // fail at Deploy to TEST
    let r = await runTimeline(mode,outcomes,{token,perStep:1100});
    if(token !== storyToken) return;
    if(r.failIdx === 2){
      setEnvState(
        mode,
        "fail",
        "System tests in TEST failed ‚Äì contract mismatch (`currency` vs `currencyCode`)."
      );
      addCon(mode,"TEST turns red for everyone while the contract bug is debugged.");
    }
    await delay(2000);
    if(token !== storyToken) return;

    // Build 2 ‚Äì integration problem still only seen in TEST
    buildSteps(mode);
    resetEnv(mode);
    setEnvLabel(mode,"Waiting for Build #2 after contract fix‚Ä¶");
    addCon(mode,"Even after the contract fix, an integration mismatch is still hidden.");

    outcomes = ["ok","ok","fail"];
    r = await runTimeline(mode,outcomes,{token,perStep:1100});
    if(token !== storyToken) return;
    if(r.failIdx === 2){
      setEnvState(
        mode,
        "fail",
        "System tests in TEST failed ‚Äì integration mismatch (rupees vs paise)."
      );
      addCon(mode,"Second failed build keeps TEST unstable and noisy.");
    }
    await delay(2000);
    if(token !== storyToken) return;

    // Build 3 ‚Äì finally stable TEST
    buildSteps(mode);
    resetEnv(mode);
    setEnvLabel(mode,"Waiting for Build #3 after all fixes‚Ä¶");
    addCon(mode,"Third build is needed before TEST is finally useful again.");

    outcomes = ["ok","ok","ok"];
    await runTimeline(mode,outcomes,{token,perStep:1100});
    if(token !== storyToken) return;

    setEnvState(
      mode,
      "ok",
      "System tests in TEST passed ‚Äì TEST is finally green."
    );
    addCon(mode,"3 separate TEST deployments for a single PR (2 of them broken).");
    await delay(2200);
  }

  /* ---------- TO-BE behaviour (3 CI runs, 1 TEST deploy) ---------- */

  async function runToBe(token){
    const mode = "to-be";

    resetPipeline(mode);
    buildSteps(mode);

    addPro(mode,"Contract & integration checks run in CI on the PR.");
    addPro(mode,"TEST only sees builds that already passed all CI gates.");
    addCon(mode,"Slightly longer CI for this PR ‚Äì more checks before merge.");

    // CI run #1 ‚Äì fail at contract tests inside PR CREATED
    setEnvLabel(mode,"TEST protected ‚Äì waiting for CI on Dev‚Äôs PR (Run #1)‚Ä¶");
    let outcomes = ["fail","skipped","skipped"]; // fail at PR CREATED
    let r = await runTimeline(mode,outcomes,{token,perStep:800});
    if(token !== storyToken) return;
    if(r.failIdx === 0){
      setEnvLabel(
        mode,
        "CI Run #1 failed inside PR CREATED ‚Äì Contract tests red, TEST untouched."
      );
      addPro(mode,"Contract mismatch is caught early on the PR branch.");
      addCon(mode,"Dev fixes contract and re-runs CI before merge.");
    }
    await delay(2000);
    if(token !== storyToken) return;

    // CI run #2 ‚Äì fail at integration tests (still inside PR CREATED)
    buildSteps(mode);
    resetEnv(mode);
    setEnvLabel(mode,"CI Run #2 ‚Äì re-testing after contract fix‚Ä¶");
    outcomes = ["fail","skipped","skipped"];
    r = await runTimeline(mode,outcomes,{token,perStep:800});
    if(token !== storyToken) return;
    if(r.failIdx === 0){
      setEnvLabel(
        mode,
        "CI Run #2 failed inside PR CREATED ‚Äì Integration tests caught rupees vs paise."
      );
      addPro(mode,"Integration issue is caught before any deploy happens.");
      addCon(mode,"Second CI run is needed, but TEST still remains clean.");
    }
    await delay(2000);
    if(token !== storyToken) return;

    // CI run #3 ‚Äì all green, single deploy to TEST
    buildSteps(mode);
    resetEnv(mode);
    setEnvLabel(mode,"CI Run #3 ‚Äì all checks expected to pass ‚Üí single deploy to TEST.");
    addPro(mode,"Once CI is green, we merge and deploy to TEST exactly once.");

    const outcomes3 = ["ok","ok","ok"];
    await runTimeline(mode,outcomes3,{token,perStep:800});
    if(token !== storyToken) return;

    setEnvState(
      mode,
      "ok",
      "Single build reaches TEST ‚Äì already green on first attempt."
    );
    addPro(mode,"TEST sees one clean build for this PR ‚Äì no firefighting.");
    await delay(2200);
  }

  /* ---------- Main comparison controller ---------- */

  async function playComparison(withIntro){
    const token = ++storyToken;
    resetPR();

    // build empty skeleton once quickly so the screen is not blank
    resetPipeline("as-is");
    buildSteps("as-is");
    resetPipeline("to-be");
    buildSteps("to-be");

    if(withIntro){
      await delay(600);
      if(token !== storyToken) return;
    }

    // 1Ô∏è‚É£ Run AS-IS completely
    await runAsIs(token);
    if(token !== storyToken) return;

    // Small pause between the two stories
    await delay(1500);
    if(token !== storyToken) return;

    // 2Ô∏è‚É£ Then run TO-BE
    await runToBe(token);
    if(token !== storyToken) return;

    // Final PR summary
    prPill.className = "pr-pill merged";
    prPill.textContent = "Merged ¬∑ TO-BE gives a cleaner path to TEST";
    prSub.textContent  = "Same PR ¬∑ AS-IS needs 3 TEST deployments vs TO-BE‚Äôs 1.";

    await delay(2600);

    // Loop again from the start
    if(token === storyToken){
      setTimeout(()=>{
        if(token === storyToken){
          playComparison(false);
        }
      }, 1200);
    }
  }

  // start automatically and loop
  playComparison(true);
})();
</script>

</body>
</html>



